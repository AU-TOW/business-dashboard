---
phase: 04-core-features
plan: 04
type: execute
---

<objective>
Update remaining API routes (notes, jotter, receipts, share, misc) to use tenant context.

Purpose: Complete tenant-aware API migration for all feature routes.
Output: All remaining routes query tenant-specific schemas.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-core-features/04-03-SUMMARY.md

**Routes to update:**

Notes (6 routes):
- app/api/autow/note/list/route.ts
- app/api/autow/note/get/route.ts
- app/api/autow/note/create/route.ts
- app/api/autow/note/update/route.ts
- app/api/autow/note/delete/route.ts
- app/api/autow/note/convert-to-booking/route.ts

Jotter (2 routes):
- app/api/autow/jotter/parse/route.ts
- app/api/autow/jotter/recognize/route.ts

Receipts (5 routes):
- app/api/autow/receipt/list/route.ts
- app/api/autow/receipt/get/route.ts
- app/api/autow/receipt/upload/route.ts
- app/api/autow/receipt/delete/route.ts
- app/api/autow/receipt/parse/route.ts

Share (3 routes):
- app/api/share/estimate/[token]/route.ts
- app/api/share/invoice/[token]/route.ts
- app/api/share/assessment/[token]/route.ts

Misc:
- app/api/autow/document-number/preview/route.ts

**CRITICAL: No schema modifications**
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update notes and jotter routes</name>
  <files>
    app/api/autow/note/list/route.ts,
    app/api/autow/note/get/route.ts,
    app/api/autow/note/create/route.ts,
    app/api/autow/note/update/route.ts,
    app/api/autow/note/delete/route.ts,
    app/api/autow/note/convert-to-booking/route.ts,
    app/api/autow/jotter/parse/route.ts,
    app/api/autow/jotter/recognize/route.ts
  </files>
  <action>
Apply tenant context pattern to all 8 routes.

For convert-to-booking (Smart Jotter flow):
- Get tenant context
- Parse note content (existing AI logic)
- Create booking in tenant schema
- This preserves the "handwritten note → structured booking" flow

```typescript
import { getTenantFromRequest, tenantQuery, tenantMutate } from '@/lib/tenant/context';

const tenant = await getTenantFromRequest(request);
if (!tenant) {
  return NextResponse.json({ error: 'Tenant required' }, { status: 400 });
}

// AI parsing logic stays the same
// Store result in tenant schema
await tenantMutate(tenant, 'INSERT INTO bookings (...) VALUES (...)', [...]);
```

For jotter routes:
- Keep OpenAI OCR logic unchanged
- Store/retrieve from tenant schema
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>8 notes/jotter routes updated</done>
</task>

<task type="auto">
  <name>Task 2: Update receipts, share, and misc routes</name>
  <files>
    app/api/autow/receipt/list/route.ts,
    app/api/autow/receipt/get/route.ts,
    app/api/autow/receipt/upload/route.ts,
    app/api/autow/receipt/delete/route.ts,
    app/api/autow/receipt/parse/route.ts,
    app/api/share/estimate/[token]/route.ts,
    app/api/share/invoice/[token]/route.ts,
    app/api/share/assessment/[token]/route.ts,
    app/api/autow/document-number/preview/route.ts
  </files>
  <action>
**Receipt routes (5):**
Apply tenant context pattern. Keep file upload logic, store metadata in tenant schema.

**Share routes (3) - SPECIAL HANDLING:**
Share links are PUBLIC (no auth). They need to:
1. Look up the share token to find which tenant it belongs to
2. Get tenant context from the token's tenant_id
3. Fetch document from tenant schema

Pattern:
```typescript
// Share routes don't use X-Tenant-Slug header
// They lookup tenant from the share token
const share = await query('SELECT * FROM public.share_tokens WHERE token = $1', [token]);
if (!share.rows[0]) {
  return NextResponse.json({ error: 'Invalid share link' }, { status: 404 });
}

const tenant = await getTenantById(share.rows[0].tenant_id);
const tenantContext = tenantToContext(tenant);

// Now fetch document from tenant schema
const estimate = await tenantQueryOne(tenantContext, 'SELECT * FROM estimates WHERE id = $1', [share.rows[0].document_id]);
```

Note: Share tokens may need to store tenant_id. If not present, check how existing share logic works and adapt accordingly.

**Document number preview:**
Apply standard tenant context pattern.
  </action>
  <verify>
Build succeeds: `npm run build`
All /api/autow/ routes use tenant context
Share routes work with public tokens
  </verify>
  <done>9 routes updated, all API routes now tenant-aware</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] All notes/jotter routes use tenant context
- [ ] All receipt routes use tenant context
- [ ] Share routes can lookup tenant from token
- [ ] Document number preview uses tenant context
- [ ] grep -r "from '@/lib/db'" app/api/autow/ shows no direct query() usage for data operations
</verification>

<success_criteria>
- All remaining API routes updated (17 routes)
- Smart Jotter → Booking flow preserved
- Share links work with tenant isolation
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-features/04-04-SUMMARY.md`
</output>
