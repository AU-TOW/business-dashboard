---
phase: 04-core-features
plan: 05
type: execute
---

<objective>
Update frontend pages to pass tenant context (X-Tenant-Slug header) with all API calls.

Purpose: Complete the tenant-aware data flow from UI to API to database.
Output: All frontend API calls include tenant identification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-core-features/04-04-SUMMARY.md

**Frontend pages using API calls:**
- app/[tenant]/dashboard/page.tsx
- app/[tenant]/booking/page.tsx
- app/[tenant]/edit/page.tsx
- app/[tenant]/estimates/page.tsx
- app/[tenant]/estimates/create/page.tsx
- app/[tenant]/estimates/edit/page.tsx
- app/[tenant]/estimates/view/page.tsx
- app/[tenant]/invoices/page.tsx
- app/[tenant]/invoices/create/page.tsx
- app/[tenant]/invoices/edit/page.tsx
- app/[tenant]/invoices/view/page.tsx
- app/[tenant]/notes/page.tsx
- app/[tenant]/notes/edit/page.tsx
- app/[tenant]/notes/view/page.tsx
- app/[tenant]/jotter/page.tsx
- app/[tenant]/receipts/page.tsx
- app/[tenant]/receipts/upload/page.tsx
- app/[tenant]/assessments/page.tsx
- app/[tenant]/assessments/create/page.tsx
- app/[tenant]/assessments/view/page.tsx

**Pattern:** Pages use useTenant() hook which provides tenant.slug
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenant-aware fetch helper</name>
  <files>lib/api/tenantFetch.ts</files>
  <action>
Create a helper that wraps fetch with tenant header:

```typescript
// lib/api/tenantFetch.ts

interface TenantFetchOptions extends RequestInit {
  tenantSlug: string;
}

export async function tenantFetch(
  url: string,
  options: TenantFetchOptions
): Promise<Response> {
  const { tenantSlug, headers, ...rest } = options;

  return fetch(url, {
    ...rest,
    headers: {
      ...headers,
      'X-Tenant-Slug': tenantSlug,
    },
  });
}

// Convenience methods
export function createTenantApi(tenantSlug: string) {
  const authToken = typeof window !== 'undefined'
    ? localStorage.getItem('autow_token')
    : null;

  const defaultHeaders: HeadersInit = {
    'Content-Type': 'application/json',
    'X-Tenant-Slug': tenantSlug,
  };

  if (authToken) {
    defaultHeaders['Authorization'] = `Bearer ${authToken}`;
  }

  return {
    get: (url: string) => fetch(url, { headers: defaultHeaders }),
    post: (url: string, body: any) => fetch(url, {
      method: 'POST',
      headers: defaultHeaders,
      body: JSON.stringify(body),
    }),
    put: (url: string, body: any) => fetch(url, {
      method: 'PUT',
      headers: defaultHeaders,
      body: JSON.stringify(body),
    }),
    delete: (url: string, body?: any) => fetch(url, {
      method: body ? 'POST' : 'DELETE',
      headers: defaultHeaders,
      body: body ? JSON.stringify(body) : undefined,
    }),
  };
}
```

This provides:
- tenantFetch() for custom requests
- createTenantApi() for common patterns with auth
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Tenant fetch helper created with convenience methods</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard and booking pages</name>
  <files>
    app/[tenant]/dashboard/page.tsx,
    app/[tenant]/booking/page.tsx,
    app/[tenant]/edit/page.tsx
  </files>
  <action>
Update fetch calls to include X-Tenant-Slug header.

Option A - Use createTenantApi:
```typescript
import { createTenantApi } from '@/lib/api/tenantFetch';
import { useTenant } from '@/lib/tenant/TenantProvider';

export default function DashboardPage() {
  const tenant = useTenant();
  const api = createTenantApi(tenant.slug);

  const fetchBookings = async () => {
    const response = await api.get('/api/autow/booking/list');
    // ...
  };
}
```

Option B - Add header directly (simpler for existing code):
```typescript
const tenant = useTenant();

const fetchBookings = async () => {
  const response = await fetch('/api/autow/booking/list', {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('autow_token')}`,
      'X-Tenant-Slug': tenant.slug,
    }
  });
  // ...
};
```

Use Option B for minimal changes to existing code. Update all fetch() calls in:
- dashboard/page.tsx - booking list, complete, delete
- booking/page.tsx - booking create
- edit/page.tsx - booking get, update
  </action>
  <verify>Build succeeds and no TypeScript errors</verify>
  <done>Dashboard and booking pages send tenant header</done>
</task>

<task type="auto">
  <name>Task 3: Update estimate, invoice, and remaining pages</name>
  <files>
    app/[tenant]/estimates/page.tsx,
    app/[tenant]/estimates/create/page.tsx,
    app/[tenant]/estimates/edit/page.tsx,
    app/[tenant]/estimates/view/page.tsx,
    app/[tenant]/invoices/page.tsx,
    app/[tenant]/invoices/create/page.tsx,
    app/[tenant]/invoices/edit/page.tsx,
    app/[tenant]/invoices/view/page.tsx,
    app/[tenant]/notes/page.tsx,
    app/[tenant]/notes/edit/page.tsx,
    app/[tenant]/notes/view/page.tsx,
    app/[tenant]/jotter/page.tsx,
    app/[tenant]/receipts/page.tsx,
    app/[tenant]/receipts/upload/page.tsx,
    app/[tenant]/assessments/page.tsx,
    app/[tenant]/assessments/create/page.tsx,
    app/[tenant]/assessments/view/page.tsx
  </files>
  <action>
For each page, add X-Tenant-Slug header to all fetch() calls:

Pattern:
```typescript
const tenant = useTenant();

// Every fetch call gets the header
const response = await fetch('/api/autow/...', {
  method: 'POST', // or GET
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('autow_token')}`,
    'X-Tenant-Slug': tenant.slug,
  },
  body: JSON.stringify(data),
});
```

Pages to update with their API calls:
- estimates/* - list, get, create, update, delete, generate-share-link, convert-to-invoice
- invoices/* - list, get, create, update, delete, mark-as-paid, generate-share-link, expenses
- notes/* - list, get, create, update, delete, convert-to-booking
- jotter - parse, recognize
- receipts/* - list, get, upload, delete, parse
- assessments/* - list, get, create, delete

Ensure useTenant() is imported from '@/lib/tenant/TenantProvider' in each file.
  </action>
  <verify>
`npm run build` succeeds
All [tenant] pages import useTenant and include X-Tenant-Slug in API calls
  </verify>
  <done>All frontend pages pass tenant context to APIs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] tenantFetch helper exists
- [ ] All [tenant]/* pages use useTenant() hook
- [ ] All fetch() calls include X-Tenant-Slug header
- [ ] Test: Dashboard loads bookings for correct tenant
</verification>

<success_criteria>
- Tenant fetch helper created
- All ~20 frontend pages updated
- API calls include X-Tenant-Slug header
- Build passes
- Phase 4 complete: full tenant-aware data flow
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-features/04-05-SUMMARY.md`

Then update:
- .planning/STATE.md - Mark Phase 4 complete
- .planning/ROADMAP.md - Update progress table
</output>
