---
phase: 04-core-features
plan: 02
type: execute
---

<objective>
Update all estimate API routes to use tenant context, preserving the booking→estimate conversion flow.

Purpose: Enable multi-tenant data isolation for estimate operations.
Output: 7 estimate API routes that query tenant-specific schemas.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-core-features/04-01-SUMMARY.md

**Estimate routes to update:**
- app/api/autow/estimate/list/route.ts
- app/api/autow/estimate/get/route.ts
- app/api/autow/estimate/create/route.ts
- app/api/autow/estimate/update/route.ts
- app/api/autow/estimate/delete/route.ts
- app/api/autow/estimate/generate-share-link/route.ts
- app/api/autow/estimate/convert-to-invoice/route.ts

**Critical flow to preserve:**
Booking → Estimate conversion: When creating estimate from booking_id, all customer/vehicle data transfers automatically (no re-entry).

**CRITICAL: No schema modifications**
- Do NOT create migrations
- Do NOT alter any tables
- Only change query execution pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update estimate CRUD routes</name>
  <files>
    app/api/autow/estimate/list/route.ts,
    app/api/autow/estimate/get/route.ts,
    app/api/autow/estimate/create/route.ts,
    app/api/autow/estimate/update/route.ts,
    app/api/autow/estimate/delete/route.ts
  </files>
  <action>
Update each route following the pattern from 04-01:
1. Import getTenantFromRequest and tenantQuery/tenantMutate/tenantQueryOne
2. Extract tenant from request header after auth check
3. Replace query() with tenant-scoped functions

For create route specifically:
- If booking_id provided, fetch booking data from tenant schema
- Transfer customer_name, customer_phone, customer_email, vehicle_* fields
- This preserves the "no re-entry" flow

Pattern:
```typescript
import { getTenantFromRequest, tenantQuery, tenantMutate, tenantQueryOne } from '@/lib/tenant/context';

// After auth check
const tenant = await getTenantFromRequest(request);
if (!tenant) {
  return NextResponse.json({ error: 'Tenant required' }, { status: 400 });
}

// If creating from booking
if (booking_id) {
  const booking = await tenantQueryOne(tenant, 'SELECT * FROM bookings WHERE id = $1', [booking_id]);
  // Use booking data to populate estimate
}
```
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>5 estimate CRUD routes use tenant context, booking→estimate flow preserved</done>
</task>

<task type="auto">
  <name>Task 2: Update estimate share link and convert routes</name>
  <files>
    app/api/autow/estimate/generate-share-link/route.ts,
    app/api/autow/estimate/convert-to-invoice/route.ts
  </files>
  <action>
Update these specialized routes:

**generate-share-link:**
- Get tenant context
- Generate share token
- Store in tenant schema
- Return shareable URL

**convert-to-invoice (CRITICAL FLOW):**
- Get tenant context
- Fetch estimate with all line items from tenant schema
- Create invoice in tenant schema with all data transferred
- Mark estimate as converted
- This is the Estimate → Invoice conversion that must preserve all data

Pattern for convert-to-invoice:
```typescript
const tenant = await getTenantFromRequest(request);
if (!tenant) {
  return NextResponse.json({ error: 'Tenant required' }, { status: 400 });
}

// Fetch estimate with items
const estimate = await tenantQueryOne(tenant, 'SELECT * FROM estimates WHERE id = $1', [estimateId]);
const items = await tenantQuery(tenant, 'SELECT * FROM estimate_items WHERE estimate_id = $1', [estimateId]);

// Create invoice with same data
const invoice = await tenantMutate(tenant,
  'INSERT INTO invoices (...) VALUES (...) RETURNING *',
  [/* estimate data */]
);

// Copy items
for (const item of items) {
  await tenantMutate(tenant,
    'INSERT INTO invoice_items (...) VALUES (...)',
    [invoice.rows[0].id, item.description, item.quantity, item.unit_price, ...]
  );
}
```
  </action>
  <verify>
Build succeeds: `npm run build`
Check estimate routes don't import from '@/lib/db' directly
  </verify>
  <done>Share link and convert routes updated, estimate→invoice conversion preserves all data</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] All 7 estimate routes use tenant context
- [ ] Booking → Estimate flow still works (booking_id parameter)
- [ ] Estimate → Invoice conversion preserves all fields and line items
</verification>

<success_criteria>
- All 7 estimate API routes updated
- Booking → Estimate data transfer preserved
- Estimate → Invoice conversion flow intact
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-features/04-02-SUMMARY.md`
</output>
