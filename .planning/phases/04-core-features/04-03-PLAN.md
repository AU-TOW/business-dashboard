---
phase: 04-core-features
plan: 03
type: execute
---

<objective>
Update all invoice API routes to use tenant context.

Purpose: Enable multi-tenant data isolation for invoice operations.
Output: 11 invoice API routes that query tenant-specific schemas.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-core-features/04-02-SUMMARY.md

**Invoice routes to update:**
- app/api/autow/invoice/list/route.ts
- app/api/autow/invoice/get/route.ts
- app/api/autow/invoice/create/route.ts
- app/api/autow/invoice/update/route.ts
- app/api/autow/invoice/delete/route.ts
- app/api/autow/invoice/mark-as-paid/route.ts
- app/api/autow/invoice/generate-share-link/route.ts
- app/api/autow/invoice/expense/list/route.ts
- app/api/autow/invoice/expense/create/route.ts
- app/api/autow/invoice/expense/delete/route.ts
- app/api/autow/invoice/expense/parse/route.ts

**CRITICAL: No schema modifications**
- Do NOT create migrations
- Only change query execution pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update invoice CRUD and status routes</name>
  <files>
    app/api/autow/invoice/list/route.ts,
    app/api/autow/invoice/get/route.ts,
    app/api/autow/invoice/create/route.ts,
    app/api/autow/invoice/update/route.ts,
    app/api/autow/invoice/delete/route.ts,
    app/api/autow/invoice/mark-as-paid/route.ts,
    app/api/autow/invoice/generate-share-link/route.ts
  </files>
  <action>
Update each route with tenant context pattern:

1. Add imports:
```typescript
import { getTenantFromRequest, tenantQuery, tenantMutate, tenantQueryOne } from '@/lib/tenant/context';
```

2. After auth check, get tenant:
```typescript
const tenant = await getTenantFromRequest(request);
if (!tenant) {
  return NextResponse.json({ error: 'Tenant required' }, { status: 400 });
}
```

3. Replace query() calls:
- SELECT → tenantQuery() or tenantQueryOne()
- INSERT/UPDATE/DELETE → tenantMutate()

4. Remove old import: `import { query } from '@/lib/db'`

Special handling for mark-as-paid:
- Update invoice status in tenant schema
- May trigger Telegram notification (keep existing logic)
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>7 invoice routes updated to tenant context</done>
</task>

<task type="auto">
  <name>Task 2: Update invoice expense routes</name>
  <files>
    app/api/autow/invoice/expense/list/route.ts,
    app/api/autow/invoice/expense/create/route.ts,
    app/api/autow/invoice/expense/delete/route.ts,
    app/api/autow/invoice/expense/parse/route.ts
  </files>
  <action>
Update expense routes (these track costs against invoices):

Apply same tenant context pattern:
```typescript
import { getTenantFromRequest, tenantQuery, tenantMutate } from '@/lib/tenant/context';

// After auth
const tenant = await getTenantFromRequest(request);
if (!tenant) {
  return NextResponse.json({ error: 'Tenant required' }, { status: 400 });
}

// Expense operations in tenant schema
const expenses = await tenantQuery(tenant, 'SELECT * FROM invoice_expenses WHERE invoice_id = $1', [invoiceId]);
```

For parse route (if it uses AI):
- Keep OpenAI logic
- Store parsed result in tenant schema
  </action>
  <verify>
Build succeeds: `npm run build`
grep -r "from '@/lib/db'" app/api/autow/invoice/ shows no direct query imports
  </verify>
  <done>4 expense routes updated, all 11 invoice routes use tenant context</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] All 11 invoice routes use tenant context
- [ ] No invoice routes import query() from '@/lib/db'
- [ ] Mark-as-paid updates status correctly
</verification>

<success_criteria>
- All 11 invoice API routes updated
- Expense tracking routes work with tenant schemas
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-features/04-03-SUMMARY.md`
</output>
