---
phase: 06-extended-features
plan: 01
type: execute
---

<objective>
Implement receipt storage using Supabase Storage instead of Google Drive.

Purpose: Simplify receipt image storage by using Supabase's built-in storage (no OAuth, same project).
Output: Working receipt upload/view with Supabase Storage, tenant-aware frontend.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-features/04-05-SUMMARY.md

**Prior decisions:**
- Phase 4: All API routes use `withTenantSchema()` for tenant isolation
- Phase 4: Frontend pages use `useTenant()` and `useTenantPath()` hooks

**Key files:**
@lib/supabase/client.ts
@lib/supabase/server.ts
@app/api/autow/receipt/upload/route.ts
@app/[tenant]/receipts/page.tsx
@app/[tenant]/receipts/upload/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Storage helper</name>
  <files>lib/supabase-storage.ts</files>
  <action>
Create a storage helper module for Supabase Storage:

1. Create `uploadReceiptImage(imageData: string, tenantSlug: string, filename: string)`:
   - Convert base64 to buffer
   - Upload to bucket `receipts` with path `{tenantSlug}/{YYYY-MM}/{filename}.jpg`
   - Return public URL

2. Create `deleteReceiptImage(path: string)`:
   - Delete file from storage
   - Handle errors gracefully

3. Create `getReceiptUrl(path: string)`:
   - Return public URL for a receipt image

Use the server-side Supabase client from `lib/supabase/server.ts`.
Storage bucket name: `receipts` (will be created if not exists via Supabase dashboard).

Note: Do NOT use Google Drive. Remove the google-drive import from upload route.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>lib/supabase-storage.ts exports uploadReceiptImage, deleteReceiptImage, getReceiptUrl functions</done>
</task>

<task type="auto">
  <name>Task 2: Update receipt upload API to use Supabase Storage</name>
  <files>app/api/autow/receipt/upload/route.ts</files>
  <action>
Modify the receipt upload route:

1. Remove Google Drive import and usage
2. Import `uploadReceiptImage` from `@/lib/supabase-storage`
3. Upload to Supabase Storage instead of Google Drive:
   - Generate filename: `{receipt_number}.jpg`
   - Path: `{tenant.slug}/{YYYY-MM}/{filename}`
4. Update database insert to use new columns:
   - `storage_file_id` -> path in storage
   - `storage_file_url` -> public URL from Supabase
   - Remove gdrive_* columns from insert
5. Keep all tenant context logic (withTenantSchema)

The receipts table already has `storage_file_id` and `storage_file_url` columns.
  </action>
  <verify>Build succeeds: `npm run build` (check for no TypeScript errors)</verify>
  <done>Receipt upload uses Supabase Storage, returns storage_file_url in response</done>
</task>

<task type="auto">
  <name>Task 3: Update receipts frontend with tenant context</name>
  <files>app/[tenant]/receipts/page.tsx, app/[tenant]/receipts/upload/page.tsx</files>
  <action>
Update both receipts pages:

1. In `receipts/page.tsx`:
   - Add `useTenant()` and `useTenantPath()` imports
   - Add `X-Tenant-Slug` header to all fetch calls (list, delete)
   - Replace hardcoded `/autow/` paths with `paths.*` equivalents
   - Update image display to use `storage_file_url` instead of `gdrive_file_url`

2. In `receipts/upload/page.tsx`:
   - Add `useTenant()` and `useTenantPath()` imports
   - Add `X-Tenant-Slug` header to upload fetch call
   - Replace hardcoded paths with tenant paths

3. Remove any Google Drive specific UI elements (the "Google Drive" button label).
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>Both receipt pages use tenant context, display Supabase Storage images</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] lib/supabase-storage.ts exports all three functions
- [ ] Receipt upload API no longer references Google Drive
- [ ] Receipts pages include X-Tenant-Slug headers
- [ ] No hardcoded `/autow/` paths in receipts pages
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Receipt images stored in Supabase Storage bucket
- Tenant isolation maintained for receipts
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-features/06-01-SUMMARY.md`
</output>
