---
phase: 06-extended-features
plan: 03
type: execute
---

<objective>
Implement feature visibility helpers and remove hardcoded AUTOW branding.

Purpose: Prepare for tier-based feature gating (Phase 5 deferred) and make UI tenant-neutral.
Output: Feature visibility utilities, tenant-branded navigation, no AUTOW references.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-features/06-01-SUMMARY.md
@.planning/phases/06-extended-features/06-02-SUMMARY.md

**Subscription tiers (from tenants table):**
- trial: 7-day trial, limited features
- starter: £12/mo - 10 bookings, 1 Telegram bot, basic features
- pro: £29/mo - Unlimited bookings, Telegram, enhanced features
- business: £59/mo - Multi-user, receipts, 3 bots
- enterprise: £99/mo - Unlimited users, API, unlimited bots

**Trade types:**
- car_mechanic: Shows vehicle fields, damage assessments
- plumber: Hides vehicle fields, shows "Materials" instead of "Parts"
- electrician: Hides vehicle fields
- builder: Hides vehicle fields
- general: Configurable

**Key files to update:**
@app/[tenant]/welcome/page.tsx
@app/[tenant]/dashboard/page.tsx
@components/smart-jotter/SmartJotter.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature visibility helper</name>
  <files>lib/features.ts</files>
  <action>
Create a feature visibility utility module:

```typescript
type SubscriptionTier = 'trial' | 'starter' | 'pro' | 'business' | 'enterprise';
type TradeType = 'car_mechanic' | 'plumber' | 'electrician' | 'builder' | 'general';

interface FeatureConfig {
  // Tier-based features
  receipts: SubscriptionTier[];
  smartJotter: SubscriptionTier[];
  damageAssessments: SubscriptionTier[];  // Also requires car_mechanic
  telegramBot: SubscriptionTier[];
  multiUser: SubscriptionTier[];
  customBranding: SubscriptionTier[];

  // Trade-specific
  vehicleFields: TradeType[];
}

const FEATURE_CONFIG: FeatureConfig = {
  receipts: ['pro', 'business', 'enterprise'],
  smartJotter: ['starter', 'pro', 'business', 'enterprise'],
  damageAssessments: ['pro', 'business', 'enterprise'],
  telegramBot: ['starter', 'pro', 'business', 'enterprise'],
  multiUser: ['business', 'enterprise'],
  customBranding: ['business', 'enterprise'],
  vehicleFields: ['car_mechanic'],
};

export function canAccessFeature(
  feature: keyof FeatureConfig,
  tier: SubscriptionTier,
  tradeType?: TradeType
): boolean {
  // Trial has all features for 7 days
  if (tier === 'trial') return true;

  const allowedTiers = FEATURE_CONFIG[feature];
  if (!allowedTiers.includes(tier)) return false;

  // Special case: damage assessments requires car_mechanic
  if (feature === 'damageAssessments' && tradeType !== 'car_mechanic') {
    return false;
  }

  return true;
}

export function getPartsLabel(tradeType: TradeType): string {
  switch (tradeType) {
    case 'plumber': return 'Materials';
    case 'electrician': return 'Components';
    case 'builder': return 'Materials';
    default: return 'Parts';
  }
}

export function shouldShowVehicleFields(tradeType: TradeType): boolean {
  return tradeType === 'car_mechanic';
}
```

This provides a central place to check feature access without needing Stripe (Phase 5).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>lib/features.ts exports canAccessFeature, getPartsLabel, shouldShowVehicleFields</done>
</task>

<task type="auto">
  <name>Task 2: Update navigation with feature visibility</name>
  <files>app/[tenant]/welcome/page.tsx, app/[tenant]/dashboard/page.tsx</files>
  <action>
Update navigation pages to use feature visibility:

1. In welcome/page.tsx (main menu):
   - Import canAccessFeature from '@/lib/features'
   - Get tenant.subscription_tier and tenant.trade_type from useTenant()
   - Conditionally render menu items:
     - Receipts: show if canAccessFeature('receipts', tier, trade)
     - Smart Jotter: show if canAccessFeature('smartJotter', tier, trade)
     - Damage Assessments: show if canAccessFeature('damageAssessments', tier, trade)
   - Grey out locked features with "Upgrade" badge (don't hide completely)

2. In dashboard/page.tsx:
   - Apply same visibility logic to quick actions
   - Show/hide stats sections based on available features

3. Remove AUTOW logo references:
   - Replace hardcoded logo URL with tenant.logo_url or generic placeholder
   - Replace "AUTOW" text with tenant.business_name

Use pattern: `{canAccessFeature('receipts', tier, trade) ? <MenuItem /> : <LockedMenuItem />}`
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>Navigation shows/hides features based on tier, no AUTOW references</done>
</task>

<task type="auto">
  <name>Task 3: Update Smart Jotter and forms with trade context</name>
  <files>
app/[tenant]/jotter/page.tsx,
app/[tenant]/booking/page.tsx,
app/[tenant]/estimates/create/page.tsx
  </files>
  <action>
Apply trade-specific customizations:

1. In jotter/page.tsx:
   - Remove AUTOW logo, use tenant branding
   - Import shouldShowVehicleFields, getPartsLabel from '@/lib/features'
   - Pass trade context to SmartJotter component (if it needs it)

2. In booking/page.tsx:
   - Conditionally show vehicle fields based on shouldShowVehicleFields(trade)
   - Non-vehicle trades: hide Make, Model, Registration fields
   - Update form validation accordingly

3. In estimates/create/page.tsx:
   - Use getPartsLabel(trade) for the "Parts" line item label
   - Conditionally show vehicle fields

This makes the forms appropriate for each trade type.
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>Forms adapt to trade type, vehicle fields hidden for non-automotive</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] lib/features.ts exports all helper functions
- [ ] Navigation shows feature visibility badges
- [ ] No hardcoded AUTOW logos or text in updated pages
- [ ] Vehicle fields hidden for non-car_mechanic trades
- [ ] Parts label changes based on trade type
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Feature visibility works based on tier/trade
- UI is tenant-branded, not AUTOW-branded
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-features/06-03-SUMMARY.md`

Update STATE.md:
- Phase: 7 of 8 (Branding & Customization)
- Progress: 75%
- Note: Phase 5 skipped, Phase 6 complete

Update ROADMAP.md:
- Phase 6 status: Complete
</output>
