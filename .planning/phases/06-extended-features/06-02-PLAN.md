---
phase: 06-extended-features
plan: 02
type: execute
---

<objective>
Implement damage assessments feature for car mechanic trade type.

Purpose: Allow mechanics to document vehicle damage with photos and share assessments with customers.
Output: Full CRUD API and UI for damage assessments, trade-type restricted.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-features/06-01-SUMMARY.md

**Database schema (already exists in tenant schema):**
```sql
CREATE TABLE damage_assessments (
    id SERIAL PRIMARY KEY,
    assessment_number VARCHAR(50) UNIQUE NOT NULL,
    assessment_date DATE NOT NULL DEFAULT CURRENT_DATE,
    status VARCHAR(50) NOT NULL DEFAULT 'draft',
    client_name VARCHAR(255) NOT NULL,
    client_email VARCHAR(255),
    client_phone VARCHAR(20),
    vehicle_make VARCHAR(100),
    vehicle_model VARCHAR(100),
    vehicle_reg VARCHAR(20) NOT NULL,
    vehicle_year VARCHAR(10),
    vehicle_color VARCHAR(50),
    mileage INTEGER,
    damage_description TEXT,
    damage_locations JSONB,  -- {front: bool, rear: bool, left: bool, right: bool, top: bool, underside: bool}
    photos JSONB,            -- [{url: string, location: string, description: string}]
    notes TEXT,
    share_token VARCHAR(64) UNIQUE,
    created_by VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Key patterns:**
- Use `withTenantSchema()` for all database queries
- Use `getTenantFromRequest()` to get tenant context
- Generate share_token with crypto.randomBytes(32).toString('hex')
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create damage assessment API routes</name>
  <files>
app/api/autow/damage-assessment/list/route.ts,
app/api/autow/damage-assessment/get/route.ts,
app/api/autow/damage-assessment/create/route.ts,
app/api/autow/damage-assessment/update/route.ts,
app/api/autow/damage-assessment/delete/route.ts,
app/api/autow/damage-assessment/generate-share-link/route.ts
  </files>
  <action>
Create CRUD API routes following the same patterns as estimates/invoices:

1. **list/route.ts** (GET):
   - Query damage_assessments table with optional status filter
   - Return assessments ordered by created_at DESC
   - Use withTenantSchema()

2. **get/route.ts** (GET):
   - Get single assessment by id (query param)
   - Return 404 if not found

3. **create/route.ts** (POST):
   - Generate assessment_number: 'DMG' + LPAD(next_num, 4, '0')
   - Accept: client_name, client_phone, client_email, vehicle_*, damage_description, damage_locations, photos, notes
   - Set status='draft', created_by from auth

4. **update/route.ts** (POST):
   - Update assessment by id
   - Allow updating all fields except id, assessment_number, created_at

5. **delete/route.ts** (POST):
   - Delete assessment by id
   - Also delete any photos from storage (if implemented)

6. **generate-share-link/route.ts** (POST):
   - Generate share_token using crypto.randomBytes(32).toString('hex')
   - Update assessment with token
   - Return shareable URL: /share/damage/{token}

All routes must check authorization and use tenant context.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>All 6 API routes created and compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create damage assessment UI pages</name>
  <files>
app/[tenant]/damage-assessments/page.tsx,
app/[tenant]/damage-assessments/create/page.tsx,
app/[tenant]/damage-assessments/view/page.tsx
  </files>
  <action>
Create UI pages following existing patterns (estimates/invoices style):

1. **page.tsx** (List view):
   - Header with title "Damage Assessments" and "New Assessment" button
   - Grid/list of assessments showing: assessment_number, vehicle_reg, client_name, status, date
   - Actions: View, Share, Delete
   - Use tenant context for API calls

2. **create/page.tsx** (Create/Edit form):
   - Form sections: Client Info, Vehicle Info, Damage Details
   - Damage locations: checkboxes for front/rear/left/right/top/underside
   - Photo upload section (store URLs in photos JSONB)
   - Save as Draft / Submit buttons
   - Pre-fill from query params if editing (id=X)

3. **view/page.tsx** (View details):
   - Display all assessment details
   - Show damage locations visually (simple car diagram or text)
   - Display photos in gallery
   - Actions: Edit, Share, Convert to Estimate (future)
   - Back button

Style: Match existing dark theme (#000 background, #30ff37 accent for mechanics).
Use useTenant() and useTenantPath() hooks.
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>All 3 pages render without errors, navigation works</done>
</task>

<task type="auto">
  <name>Task 3: Add damage assessments to navigation (car_mechanic only)</name>
  <files>app/[tenant]/welcome/page.tsx, app/[tenant]/dashboard/page.tsx</files>
  <action>
Add damage assessments link to navigation, but only for car_mechanic trade type:

1. In welcome/page.tsx (menu page):
   - Add "Damage Assessments" menu item with car icon
   - Only show if tenant.trade_type === 'car_mechanic'
   - Link to paths.damageAssessments (add to useTenantPath if needed)

2. In dashboard/page.tsx:
   - Add damage assessments count to stats (if car_mechanic)
   - Add quick action button for "New Assessment"

3. Update useTenantPath in lib/tenant/TenantProvider.tsx:
   - Add `damageAssessments: \`/${tenant.slug}/damage-assessments\``
   - Add `damageAssessmentsCreate: \`/${tenant.slug}/damage-assessments/create\``

The trade_type check ensures plumbers/electricians don't see this feature.
  </action>
  <verify>Build succeeds: `npm run build`</verify>
  <done>Damage assessments visible in nav for car_mechanic, hidden for other trades</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] All 6 API routes exist and handle requests correctly
- [ ] All 3 UI pages render without errors
- [ ] Damage assessments menu item shows only for car_mechanic trade
- [ ] CRUD operations work end-to-end
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Car mechanics can create, view, edit, delete damage assessments
- Other trade types don't see the feature
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-features/06-02-SUMMARY.md`
</output>
