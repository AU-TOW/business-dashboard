# Plan 03-01: Authentication & Onboarding

## Objective

Implement magic link (passwordless) authentication using Supabase Auth, create a signup flow with trade type selection and business details capture, and build a welcome/onboarding experience with 7-day trial activation.

## Execution Context

**Phase**: 3 of 8 (Authentication & Onboarding)
**Dependencies**: Phase 2 (Multi-Tenancy Architecture) - Complete
**Mode**: Interactive
**Estimated Tasks**: 8

### Key Decisions (from PROJECT.md)
- Magic link authentication (modern UX, passwordless)
- 7-day free trial for new signups
- 5 trade types: Car Mechanic, Plumber, Electrician, Builder, General Trades
- Light glass UI theme (glassmorphism, light blue backgrounds)

### Technical Foundation
- Supabase Auth with `signInWithOtp` for magic links
- `emailRedirectTo` for callback handling
- PKCE flow with token verification
- Existing tenant provisioning system (`lib/tenant/provisioning.ts`)

## Context

### Current State
- Multi-tenancy architecture complete (schema-per-tenant)
- Tenant types defined: `TradeType`, `SubscriptionTier`, `Tenant`, `TenantContext`
- Tenant provisioning ready: `createTenant()`, `generateSlug()`, `isSlugAvailable()`
- TenantProvider with hooks: `useTenant()`, `useTenantPath()`, `useBranding()`, `useHasFeature()`
- Legacy auth exists at `app/api/autow/auth/login/route.ts` (username/password)
- Legacy login page at `app/autow/page.tsx`

### Files to Create/Modify
**New Files:**
- `lib/supabase/client.ts` - Supabase browser client
- `lib/supabase/server.ts` - Supabase server client
- `lib/auth/session.ts` - Session management utilities
- `app/signup/page.tsx` - Public signup page
- `app/signup/verify/page.tsx` - Magic link callback handler
- `app/[tenant]/onboarding/page.tsx` - Post-signup onboarding
- `app/api/auth/signup/route.ts` - Signup API endpoint
- `app/api/auth/magic-link/route.ts` - Send magic link
- `app/api/auth/callback/route.ts` - Magic link verification
- `middleware.ts` - Auth middleware for protected routes

**Modify:**
- `app/[tenant]/layout.tsx` - Add auth check
- `app/autow/page.tsx` - Convert to magic link login
- `lib/tenant/provisioning.ts` - Link tenant to Supabase user

### Supabase Auth Pattern
```typescript
// Send magic link
const { error } = await supabase.auth.signInWithOtp({
  email: email,
  options: {
    emailRedirectTo: `${origin}/signup/verify?tenant=${slug}`,
  }
});

// Verify on callback (verify page)
const { data: { session }, error } = await supabase.auth.verifyOtp({
  token_hash: token,
  type: 'email'
});
```

## Tasks

### Task 1: Set Up Supabase Auth Client
**Goal**: Create Supabase client utilities for browser and server contexts

Create:
- `lib/supabase/client.ts` - Browser client with `createBrowserClient`
- `lib/supabase/server.ts` - Server client with cookie handling
- Add `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` to `.env.local.example`

**Verification**: Import clients without errors

### Task 2: Create Signup Page
**Goal**: Build public signup form with trade selection and business details

Create `app/signup/page.tsx`:
- Email input (required)
- Business name input (required)
- Trade type dropdown (5 options)
- Phone (optional)
- Auto-generate slug from business name
- Light glass UI theme styling
- "Start Free Trial" button

**Verification**: Page renders at `/signup` with form validation

### Task 3: Implement Signup API
**Goal**: Create signup endpoint that provisions tenant and sends magic link

Create `app/api/auth/signup/route.ts`:
- Validate inputs (email, business name, trade type)
- Check slug availability
- Create tenant via `createTenant()`
- Send magic link via Supabase Auth
- Return success/error response

**Verification**: POST `/api/auth/signup` creates tenant and sends email

### Task 4: Create Magic Link Callback Handler
**Goal**: Handle magic link verification and establish session

Create `app/signup/verify/page.tsx`:
- Extract `token_hash` from URL
- Verify OTP with Supabase
- Link Supabase user to tenant
- Redirect to onboarding or dashboard

**Verification**: Clicking magic link in email completes verification

### Task 5: Build Onboarding Flow
**Goal**: Welcome new users and optionally collect additional details

Create `app/[tenant]/onboarding/page.tsx`:
- Welcome message with business name
- Trial status display (7 days remaining)
- Optional: Additional business details (address, bank info)
- "Go to Dashboard" button
- Light glass UI theme

**Verification**: New users see onboarding after first login

### Task 6: Implement Auth Middleware
**Goal**: Protect tenant routes with session verification

Create/update `middleware.ts`:
- Check for valid Supabase session
- Verify user belongs to tenant
- Redirect unauthenticated users to login
- Allow public routes: `/signup`, `/share/*`, landing page

**Verification**: Unauthenticated access to `/[tenant]/dashboard` redirects to login

### Task 7: Update Login Page for Magic Link
**Goal**: Convert legacy login to magic link authentication

Update `app/autow/page.tsx` â†’ `app/[tenant]/login/page.tsx`:
- Email-only input (no password)
- "Send Magic Link" button
- Success message after email sent
- Light glass UI theme
- Link to signup for new users

**Verification**: Login page sends magic link, no password field

### Task 8: Link Supabase Users to Tenants
**Goal**: Associate authenticated users with their tenant

Update `lib/tenant/provisioning.ts`:
- Add `owner_user_id` column to tenants table (migration)
- Store Supabase user ID on tenant creation
- Add `getTenantByUserId()` function

Create migration `database/migrations/002_add_owner_user_id.sql`

**Verification**: Tenant record includes owner's Supabase user ID

## Verification

### Build Verification
```bash
npm run build
npm run lint
```
Should complete without errors.

### Manual Testing
1. Visit `/signup` - form displays correctly
2. Submit signup - magic link email received
3. Click magic link - verification succeeds
4. Redirected to onboarding - welcome message shows
5. Complete onboarding - arrives at dashboard
6. Logout and try `/[tenant]/dashboard` - redirected to login
7. Login with magic link - returns to dashboard

### Database Verification
```sql
-- Check tenant created with owner
SELECT slug, business_name, owner_user_id FROM public.tenants;

-- Check Supabase user linked
SELECT id, email FROM auth.users;
```

## Success Criteria

- [ ] Supabase Auth clients configured and working
- [ ] Signup form collects all required fields
- [ ] Tenant provisioned on signup with 7-day trial
- [ ] Magic link emails sent and verified
- [ ] Session established after verification
- [ ] Onboarding flow welcomes new users
- [ ] Protected routes require authentication
- [ ] Login page uses magic link (no password)
- [ ] Supabase user linked to tenant record

## Output

**Files Created:**
- `lib/supabase/client.ts`
- `lib/supabase/server.ts`
- `lib/auth/session.ts`
- `app/signup/page.tsx`
- `app/signup/verify/page.tsx`
- `app/[tenant]/onboarding/page.tsx`
- `app/[tenant]/login/page.tsx`
- `app/api/auth/signup/route.ts`
- `app/api/auth/magic-link/route.ts`
- `app/api/auth/callback/route.ts`
- `middleware.ts`
- `database/migrations/002_add_owner_user_id.sql`

**Files Modified:**
- `lib/tenant/provisioning.ts`
- `.env.local.example`

**Next Phase**: Phase 4 (Core Features - Tenant-Aware)
