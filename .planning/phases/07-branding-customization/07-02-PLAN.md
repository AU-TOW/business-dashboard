---
phase: 07-branding-customization
plan: 02
type: execute
---

<objective>
Implement dynamic theming system with CSS variables for tenant branding.

Purpose: Allow Business+ tier tenants to customize their primary color across the app.
Output: CSS variable system, color picker in settings, theme applied to all pages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-branding-customization/07-01-SUMMARY.md

**Tier-gated:**
- Business+: Primary color customization
- Lower tiers: Default blue (#3B82F6)

**Current state:**
- TenantProvider has primaryColor in context
- useBranding() returns primaryColor
- All pages use inline styles with hardcoded colors

**Approach:**
- Use CSS custom properties (--primary-color, --primary-rgb)
- Set in tenant layout based on tenant.primaryColor
- Components reference CSS variables
- Graceful fallback to blue default

@lib/tenant/TenantProvider.tsx
@lib/features.ts
@app/[tenant]/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme provider and CSS variables</name>
  <files>
lib/theme/ThemeProvider.tsx,
app/[tenant]/layout.tsx
  </files>
  <action>
1. Create ThemeProvider component that:
   - Receives primaryColor from tenant context
   - Sets CSS custom properties on document root:
     - --primary-color: the hex color
     - --primary-rgb: the RGB values for rgba() usage
     - --primary-light: 10% lighter version
     - --primary-dark: 10% darker version
   - Provides theme context with helper functions

2. Update tenant layout to wrap with ThemeProvider:
   - Get tenant from context
   - Pass primaryColor to ThemeProvider
   - ThemeProvider sets CSS variables in useEffect

3. Add canCustomizeTheme check:
   - Import canAccessFeature from lib/features
   - Add 'customBranding' feature check (business+ only)
   - If tier can't customize, use default blue

Helper function to extract RGB:
```typescript
function hexToRgb(hex: string): string {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  if (!result) return '59, 130, 246'; // default blue
  return `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}`;
}
```
  </action>
  <verify>CSS variables visible in browser dev tools when inspecting tenant pages</verify>
  <done>
- ThemeProvider sets CSS variables
- Layout wraps content with ThemeProvider
- Variables update based on tenant primaryColor
  </done>
</task>

<task type="auto">
  <name>Task 2: Add color picker to settings page</name>
  <files>
app/[tenant]/settings/page.tsx
  </files>
  <action>
Add "Branding" section to settings page:

1. **Color Picker** (Business+ only):
   - Show current primaryColor as swatch
   - Native HTML color input
   - Preview how color looks on sample button
   - Tier-gated: show upgrade badge for lower tiers

2. **Implementation:**
   - Add primaryColor to settings form state
   - Include in POST to /api/autow/tenant/settings
   - Show "Upgrade to Business" message for Starter/Pro tiers
   - Use canAccessFeature('customBranding', tier) for gating

3. **Preview:**
   - Show sample button with selected color
   - "This color will be used for buttons and accents"

Add customBranding to lib/features.ts FEATURE_CONFIG if not already present.
  </action>
  <verify>Color picker visible for Business tier, locked for lower tiers</verify>
  <done>
- Color picker in settings page
- Tier-gated with upgrade message
- Color saves to database
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply theme to key components</name>
  <files>
app/[tenant]/welcome/page.tsx,
app/[tenant]/dashboard/page.tsx,
app/[tenant]/settings/page.tsx
  </files>
  <action>
Update key pages to use CSS variables:

1. Replace hardcoded blue (#3B82F6) with var(--primary-color)
2. Replace rgba(59, 130, 246, X) with rgba(var(--primary-rgb), X)

Target elements:
- Primary buttons (save, submit)
- Card borders/shadows
- Header accents
- Active/selected states

Keep semantic colors (red for errors, green for success) unchanged.

Add global CSS in layout:
```css
:root {
  --primary-color: #3B82F6;
  --primary-rgb: 59, 130, 246;
}
```

This provides fallback if ThemeProvider hasn't loaded yet.
  </action>
  <verify>npm run build succeeds, changing primaryColor updates UI colors</verify>
  <done>
- Key components use CSS variables
- Theme changes reflect across app
- Fallback to default blue works
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] CSS variables set correctly on tenant pages
- [ ] Color picker works for Business+ tiers
- [ ] Lower tiers see upgrade message for color customization
- [ ] Changing color updates UI across pages
- [ ] Default blue used when no custom color set
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Dynamic theming works based on tenant settings
- Tier gating enforced for color customization
</success_criteria>

<output>
After completion, create `.planning/phases/07-branding-customization/07-02-SUMMARY.md`

Update STATE.md:
- Plan: 07-02 complete, 07-03 ready
</output>
